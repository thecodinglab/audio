<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebRTC Demo</title>
  </head>
  <body>
    <script>
    const el = document.createElement("audio");
    el.controls = true;
    el.volume = 0.1;
    document.body.appendChild(el);


    function connect() {
      const pc = new RTCPeerConnection({
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
      });

      pc.addEventListener("negotiationneeded", () => {
        pc.createOffer().then((offer) => pc.setLocalDescription(offer));
      });

      pc.addEventListener("icecandidate", (e) => {
        if (!e.candidate) {
          fetch("/webrtc", { method: "POST", body: JSON.stringify(pc.localDescription) })
            .then((res) => res.json())
            .then((answer) => pc.setRemoteDescription(answer));
        }
      });

      pc.addEventListener("connectionstatechange", () => {
        console.log(pc.connectionState); // TODO reconnect?
        if (pc.connectionState === "disconnected" || pc.connectionState === "failed") {
          connect();
        }
      });

      pc.addEventListener("track", (event) => {
        el.srcObject = event.streams[0];
        el.play();
      });

      pc.addTransceiver("audio", {
        direction: "recvonly",
      });
    }

    connect();
    </script>
  </body>
</html>
